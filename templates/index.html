<!DOCTYPE html>
<html>
    <head>
        <link rel="shortcut icon" type="image/png" href="static/css/research.png"/>
        <title>Invenio</title>
        <meta charset="utf-8" />

        <!--Bootstrap-->
        <link rel="stylesheet" href="{{ url_for('static', filename='lib/bootstrap/bootstrap.min.css') }}">
        <!--<script src="{{url_for('static', filename='somejavascriptfile.js')}}"></script>-->
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>




        {% if output %}
        <link rel="stylesheet" href="{{ url_for('static', filename='lib/leaflet/leaflet.css') }}">
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>

        <link rel="stylesheet" href="{{ url_for('static', filename='lib/leaflet/MarkerCluster.Default.css') }}">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.4.1/leaflet.markercluster.js"/></script>

        <link rel="stylesheet" href="{{ url_for('static', filename='lib/nouislider/nouislider.css') }}">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.2/nouislider.js"/></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.1.0/wNumb.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.5.0"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.js"></script>
        

        {% endif %}


        <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
        <link rel="stylesheet" href="static/css/main.css"/>
 

 
    </head>
    <body style="background-color:  #494949">
            
            <nav class="navbar navbar-expand-lg navbar-dark bg-transparent" style=" z-index:1000">
                    {% if step != "query" %}
                    <a class="navbar-brand" href="/" style="margin-left:15px">inven<b class="text-white">IO</b></a>
                    {% endif %}
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                          </button>
                    
                  
                    <div class="collapse navbar-collapse" id="navbarSupportedContent">
                      <ul class="navbar-nav mr-auto">
                        {% if step == "query" %}
                        <li class="nav-item active">
                        {% else %}
                        <li class="nav-item">
                        {% endif %}
                          <a class="nav-link" href="/">HOME</a>
                        </li>
                        {% if step == "documentation" %}
                        <li class="nav-item active">
                        {% else %}
                        <li class="nav-item">
                        {% endif %}
                          <a class="nav-link" href="/documentation">DOCUMENTATION</a>
                        </li>
                        <li class="nav-item">
                                <a style="color: rgba(255,255,255,.5) !important" class="nav-link" target="_blank" href="https://github.com/Inveniet/Inveniet">GITHUB</a>
                        </li>
                        {% if step == "about" %}
                        <li class="nav-item active">
                        {% else %}
                        <li class="nav-item">
                        {% endif %}
                                <a class="nav-link" href="/about">ABOUT</a>
                        </li>
                      </ul>
                    </div>
            </nav>
        
        <!--step query-->
        {% if step == "query" %}
            <div class="container-fluid">
                <div class="row">
                        <div class="col-md-2"></div>
                        <div class="col-md-8" id="imgcont">
                                <img src="static\css\background1.png" style="width: 100%; color: linear-gradient( rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.2) )"/>
                        </div>
                        <div class="col-md-2"></div>
                </div>
                <div class="row bg-dark">
                            <div class="col-md-2"></div>
                            <div class="col-md-8" style="padding-top: 10px; padding-bottom:30px">
                                    <h1 class="text-light" style="padding-top:10px">inven<b class="text-white">IO</b></h1>
                                    <h5 style="color: rgba(255,255,255,.5); padding-bottom:10px">Epigraphic Boolean Search Engine</h5>
                                    <form action= "/query"  method="POST" onsubmit="$('#load').modal('show')">
                                            <div class="input-group">
                                                <input id="inputmain" autocomplete="false" style="color:white; background-color: rgba(1,1,1,0.4) !important;" type="text" class="form-control" id="s" name="query" placeholder="Enter query" pattern="[a-zA-Z ]+" required>
                                                <span class="input-group-btn">
                                                <input id="fire" type="submit" name="commit" value="Search" class="btn btn-secondary" style="border-radius: 0rem .25rem .25rem 0rem !important" data-disable-with="Search">
                                            </span> 
                                            </div>
                                            <h6 style="margin-top:10px"><a href="" data-toggle="modal" data-target="#tutorial">New to Boolean Search?</a></h6>
            
                                    </form>

                            </div>
                            <div class="col-md-2"></div>
                </div>
                <div class="row">
                        <div class="col-md-2"></div>
                        <div class="col-md-8">
                                <div class="accordion bg-light" id="accordionExample">
                                        <div class="card">
                                          <div class="card-header" id="headingOne">
                                            <h2 class="mb-0">
                                              <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                <h5 class="text-dark">Use Case I: The Eagle of the Ninth</h5>
                                              </button>
                                            </h2>
                                          </div>
                                      
                                          <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
                                            <div class="card-body">
                                                    <p>In this example <b>Invenio</b> will find all documents about the Legio IX Hispana (also written Legio nona Hispana or Legio VIIII Hispana), a legion of the Imperial Roman army.</p>
                                                    <textarea id="demoval1" style="width: 100%; height: 80px; resize:none; margin-top:10px; margin-bottom:5px" readonly>legio OR legionis OR legioni OR legionem OR legione AND ix OR viiii OR nona OR nonae OR nonam AND hispana OR hispanae OR hispanam</textarea>
                                                    <p>This query combines (AND) 3 sub-queries:</p>
                                                    <ul>
                                                            <li><b>"legio OR legionis OR legioni OR legionem OR legione"</b>: query the noun "legio" in all possible declension cases.</li>
                                                            <li><b>"ix OR viiii or nona or nonae or nonam"</b>: query the number 9 both roman numbers and in words (any declension cases).</li>
                                                            <li><b>"hispana OR hispanae OR hispanam"</b>: query the adjective "hispana" in all possible declension cases.</li>
                                                    </ul> 
                                                    <button id="demo1" class="btn btn-secondary">Try this query</button>
                                            </div>
                                          </div>
                                        </div>
                                        <div class="card">
                                          <div class="card-header" id="headingTwo">
                                            <h2 class="mb-0">
                                              <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                                    <h5 class="text-dark">Use Case II: Here Comes the Sun</h5>
                                              </button>
                                            </h2>
                                          </div>
                                          <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                                            <div class="card-body">
                                                    <p>In this example <b>Invenio</b> will find all documents about Mithras (also written Mitras or Mitrhas), a deity of the Roman Empire</p>
                                                    <textarea id="demoval2" style="width: 100%; height: 80px; resize:none; margin-top:10px; margin-bottom:5px" readonly>mithras OR mithrae OR mithram OR mithra OR mitras OR mitrae OR mitram OR mihra OR mitrhas OR mitrhae OR mitrham OR mitrha</textarea>
                                                    <p>This query retrieves the word mithras in any form and declension:</p>
                                                    <ul>
                                                            <li><b>"mithras OR mithrae OR mithram OR mithra"</b>: query the noun "mithras" in all possible declension cases.</li>
                                                            <li><b>"mitras OR mitrae OR mitram OR mitra"</b>: query the noun "mitras" in all possible declension cases.</li>
                                                            <li><b>"mitrhas OR mitrhas OR mitrham OR mitrha</b>: query the noun "mitrhas" in all possible declension cases.</li>
                                                    </ul> 
                                                    <button id="demo2" class="btn btn-secondary">Try this query</button>
                                            </div>
                                          </div>
                                        </div>
                                        <div class="card">
                                          <div class="card-header" id="headingThree">
                                            <h2 class="mb-0">
                                              <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                                    <h5 class="text-dark">Use Case III: The Lady</h5>
                                              </button>
                                            </h2>
                                          </div>
                                          <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
                                            <div class="card-body">
                                                    <p>In this example <b>Invenio</b> will find all documents about Iulia Domna (160–217 AD), a powerfull Roman Empress.</p>
                                                    <textarea id="demoval3" style="width: 100%; height: 80px; resize:none; margin-top:10px; margin-bottom:5px" readonly>iulia OR iuliae OR iuliam AND domna OR domnae OR domnam</textarea>
                                                    <p>This query combines (AND) 2 sub-queries:</p>
                                                    <ul>
                                                            <li><b>"iulia or iuliae or iuliam"</b>: query the <i>nomen</i> "iulia" in all possible declension cases.</li>
                                                            <li><b>"domna or domnae or domnam"</b>: query the <i>cognomen</i> "domna" in all possible declension cases.</li>
                                                    </ul> 
                                                    <button id="demo3" class="btn btn-secondary">Try this query</button>
                                                    </div>
                                                    <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>                                            
                                                </div>
                                          </div>
                                        </div>
                                </div>
                        </div>
                        <div class="col-md-2"></div>
                </div>
            </div>


                <!-- Modal Tutorial-->
                <div class="modal fade" id="tutorial" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLongTitle">New to Boolean Search?</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                </div>
                                <div class="modal-body">
                                        <p>
                                                Boolean Search is a type of query that combine keywords and Boolean operators (AND, OR and NOT) to refine results.
                                        </p>
                                        <div style="margin-left: 25px; margin-right: 25px">
                                            <h6>AND</h6>
                                            <p>Ex: <b>"titius AND gaius"</b> This query will retrieve all documents having both "titius" and "gaius".</p>
                                            <h6>OR</h6>
                                            <p>Ex: <b>"caesar OR nihil"</b> This query will retrieve all documents containing the word "caesar" or containing the word "nihil" or both.</p>
                                            <h6>NOT</h6>
                                            <p>Ex: <b>"NOT olet"</b> This query will retrieve all documents except for those who contain the word "olet".</p>
                                            
                                            <h4 style="margin-top:40px">Combine Operators</h4>
                                            <p>Boolean search operators can be used in any combination, but there is an order in which the operations are executed: </p>
                                                <ul>
                                                    <li>First all NOT operators,</li>
                                                    <li>Then all OR operators,</li>
                                                    <li>Finally all AND operators</li>
                                                </ul> 
                                            <p>Ex. <b>"imperator AND tiberius OR imperator AND NOT nero"</b> will be executed in the following order: imperator AND (tiberius OR imperator) AND (NOT nero)</p>
                                        </div>
                                </div>
                                <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                </div>

                <div class="modal modal-backdrop" id="load" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-dialog-centered" role="document">
                          <div class="modal-content" style="background: transparent !important; border: 0 !important">
                            <div class="loader"></div>
                          </div>
                        </div>
                </div>

                
            <script>
                    $("#demo1").on("click", function() {
                        $("#inputmain").val($("#demoval1").val()),
                        $("#fire").click()
                    })
                    $("#demo2").on("click", function() {
                        $("#inputmain").val($("#demoval2").val()),
                        $("#fire").click()
                    })
                    $("#demo3").on("click", function() {
                        $("#inputmain").val($("#demoval3").val()),
                        $("#fire").click()
                    })
            </script>   
        {% endif %}


        <!--step results-->
        {% if step == "results" %}
        <div class="navbar-support" style="height:60px"></div>
        <div class="container-fluid">
        <div class="row">
            <div class="col-md-3">
                    <a href="{{ url_for('index') }}">  <button style="margin: 15px" class="btn btn-dark" type="button"><b><</b> BACK for a new Query</button></a>
            </div>
            <div class="col-md-6 bg-dark" style="padding: 25px; border-radius:.3rem .3rem 0 0">
                    {% if output %}
                    <div class="text-white" style="padding: 3px">Query: <span style="color:rgba(255,255,255,.5);">"{{ query }}"</span></div>
                    <div id="downloadcontainer" class="text-white" style="padding: 3px">Total documents: <span style="color:rgba(255,255,255,.5);">{{ output|length }}</span></div>
                    {% else %}
                    <div class="text-white" style="padding: 3px">Query: <span style="color:rgba(255,255,255,.5);">"{{ query }}"</span></div>
                    <div class="text-white" style="padding: 3px; height: 100vh"><h3>NO RESULTS</h3></div>
                    {% endif %}
            </div>
            <div class="col-md-3"></div>
        </div>

            {% if output %}
            <div class="row bg-light" style="padding-top: 20px">
                    {% if min != max %}
                    <div class="col-md-6">
                            <div id="map" style="height: 500px; margin-bottom: 15px" ></div>
                    </div>
                    <div class="col-md-6" style="margin-top: 10px;">
                            <div style="margin-right: auto; margin-left: auto; width: 90%; margin-bottom: 10px; text-align: center;">
                                <div id="counter"></div>
                                    <button class="btn btn-dark timevent" id="prev"><</button>
                                        DATE: <input type="number" min='{{ min }}' max= '{{ max }}' step="1" id="input-date"> <span id="dateprefix"></span>
                                    <button class="btn btn-dark timevent" id="next">></button>
                                    <div id="datestat"></div>
                            </div>
                            <div id="timeline" style="margin-right:10px; margin-left: 10px"></div>
                            <div id="chartcontainer">
                            <canvas id="chart"></canvas>
                        </div>
                    </div>
                    {% else %}
                    <div class="col-md-3"></div>
                    <div class="col-md-6">
                            <div id="map" style="height: 500px; margin-bottom: 15px" ></div>
                    </div>
                    <div class="col-md-3"></div>
                    {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!--DOCUMENTATION-->
        {% if step == "documentation" %}
        <div class="navbar-support" style=" height:60px"></div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3 "></div>
                <div class="col-md-6 bg-light" style="border-radius:.3rem .3rem 0 0; padding: 25px">
                        <h2>Documentation</h2>
                </div>
                <div class="col-md-3"></div>
            </div>
        </div>
        {% endif %}


        <!--About-->
        {% if step == "about" %}
        <div class="navbar-support" style="height:60px"></div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3"></div>
                <div class="col-md-6 bg-light" style="border-radius:.3rem .3rem 0 0; padding: 25px">
                        <h2>About</h2>
                        <p><b>InvenIO</b> has been developed by <a href="https://github.com/FabioMariani" target="_blank">Fabio Mariani</a> during <a href="https://www.unibo.it/it/didattica/insegnamenti/insegnamento/2018/412803" target="_blank">Digital Humanities: Sources and Methods</a> course of Digital Humanities and Digital Knowledge Master Degree at Università di Bologna.</p>

                        <p><b>InvenIO</b> name: 
                            <ul>
                                <li><i>Invenio</i> is a fourth conjugation latin verb, it means "I find".</li>
                                <li>IO is an abbreviation for input-output in computer science.</li>
                            </ul>
                        </p>

                        <p><b>InvenIO</b> is a derivative work of the following datasets:
                            <ul>
                                <li><a href="https://edh-www.adw.uni-heidelberg.de/home/" target="_blank">Epigraphic Database Heidelberg</a> - <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank">CC BY-SA 4.0</a></li>
                                <li><a href="https://dare.ht.lu.se/" target="_blank">Digital Atlas of the Roman Empire</a> - <a href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank">CC BY-SA 3.0</a></li>
                            </ul>
                        </p>

                        <p><b>InvenIO</b> website is supported by the following libraries:
                            <ul>
                                <li><a href="https://getbootstrap.com/" target="_blank">Bootstrap</a> - <a href="https://github.com/twbs/bootstrap/blob/master/LICENSE" target="_blank">MIT license</a></li>
                                <li><a href="https://leafletjs.com/" target="_blank">Leaflet</a> - <a href="https://github.com/Leaflet/Leaflet/blob/master/LICENSE" target="_blank">BSD 2-Clause "Simplified" License</a></li>
                                    <ul>
                                        <li><a href="https://github.com/Leaflet/Leaflet.markercluster" target="_blank">Leaflet Markercluster Plugin</a> - <a href="https://github.com/Leaflet/Leaflet.markercluster/blob/master/MIT-LICENCE.txt" target="_blank">MIT license</a></li>
                                    </ul>
                                <li><a href="https://www.chartjs.org/" target="_blank">Chartjs</a> - <a href="https://github.com/chartjs/Chart.js/blob/master/LICENSE.md" target="_blank">MIT license</a></li>
                                    <ul>
                                        <li><a href="https://github.com/chartjs/chartjs-plugin-datalabels" target="_blank">Chartjs Datalabels Plugin</a> - <a href="https://github.com/chartjs/chartjs-plugin-datalabels/blob/master/LICENSE.md" target="_blank">MIT license</a></li>
                                        <li><a href="https://github.com/chartjs/chartjs-plugin-annotation" target="_blank">Chartjs Annotations Plugin</a> - <a href="https://github.com/chartjs/chartjs-plugin-annotation/blob/master/LICENSE.md" target="_blank">MIT license</a></li>
                                    </ul>
                                <li><a href="https://refreshless.com/nouislider/" target="_blank">noUiSlider</a> - <a href="https://github.com/leongersen/noUiSlider/blob/master/LICENSE.md" target="_blank">MIT license</a></li>
                            </ul>
                        </p>

                        <p><b>InvenIO</b> homepage picture:
                            <ul>
                                <li><a href="http://www.getty.edu/art/collection/objects/7009/unknown-maker-grave-naiskos-of-an-enthroned-woman-with-an-attendant-east-greek-about-100-bc/?dz=0.5000,0.3934,0.71" target="_blank">Unknown, Grave Naiskos of an Enthroned Woman with an Attendant, about 100 B.C., Marble (The J. Paul Getty Museum, Villa Collection, Malibu, California)</a> - Digital image courtesy of the <a href="http://www.getty.edu/about/whatwedo/opencontent.html" target="_blank">Getty's Open Content Program</a></li>
                            </ul>

                        </p>
                        
                        <p><b>InvenIO</b>, in respect of the abovementioned licenses and the <a href="http://opendefinition.org/" target="_blank">Open Definition principles</a>, has been released under a <a href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p>

                </div>
                <div class="col-md-3"></div>
            </div>
        </div>
        {% endif %}
    

        <footer class="footer bg-dark text-white" style="margin-bottom: 0px;padding-top: 80px; padding: 20px">
            
                <div class="container-fluid text-center py-2" style="font-size: 80%">
                        <div  style="margin-bottom: 10px">
                                <b>Powered by:</b>
                                <a href="https://getbootstrap.com/" class="text-light" target="_blank">Bootstrap</a>, 
                                <a href="https://leafletjs.com/" class="text-light" target="_blank">Leaflet</a>, 
                                <a href="https://www.chartjs.org/" class="text-light" target="_blank">Chartjs</a>,
                                <a href="https://refreshless.com/nouislider/" class="text-light" target="_blank">noUiSlider</a>
                        </div>
                          
                        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"target="_blank"> <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a  style="color: grey" rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" target="_blank">Creative Commons Attribution-ShareAlike 4.0 International License</a>.


     {% if output %}

    <script>


    $( document ).ready(function() {


        var map = L.map('map', {
			maxZoom: 11,
			minZoom: 4,
			maxBoundsViscosity: 1,
		});

		map.setView([45.43, 13.18], 4);
		imageBounds = [
			[21.08, -28.04],
			[62.12, 50.54]
		]; 
		map.on("zoomstart", function () {
			zoomLev = map.getZoom(6)
		})
		map.setMaxBounds(imageBounds);
        var basemap_0 = L.tileLayer('https://dare.ht.lu.se/tiles/imperium/{z}/{x}/{y}.png', {id: 'DARE' ,attribution: 'Map Tiles: <a href="https://dare.ht.lu.se/" target="_blank">DARE</a>'});
        basemap_0.addTo(map);


        var epigraphs = JSON.parse('{{ output | tojson | safe }}'); 


        function acdc(str)
        {
            if (str.includes("-")){
                return str.replace("-","") + " B.C."
            }
            else{
                return str + " A.D."
            }
        }
        function popupstring(str, uri){
            if (str.length <= 300)
            {
                return str
            }
            else
            {
                return str.slice(0, 300) + " <a href='" + uri + "&lang=en'  target='_blank'>(continue reading)</a>"
            }
        }   


        function pop_epigraphs(feature, layer) {
            var popupContent = '<b>ID: ' + "<a href='" + String(feature.properties['epigraph']) + "&lang=en'  target='_blank'>" + String(feature.properties['id']) + '</a></b>' +
                               '<br> <b>Text:</b> ' + popupstring(String(feature.properties['text']), String(feature.properties['epigraph'])) +
                               '<br> <b>Place:</b> ' +  "<a href='" + String(feature.properties['place']) + "&lang=en' target='_blank'>" + String(feature.properties['place_name']) + '</a>' +
                               '<br> <b>Period:</b> ' + acdc(String(feature.properties['start'])) + " - " + acdc(String(feature.properties['end'])) ;

            layer.bindPopup(popupContent);
        }

        function epigraphs_marker(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8.0,
                fillColor: '#5bc0de',
                color: '#000000',
                weight: 1,
                opacity: 1.0,
                fillOpacity: 0.8
            })
        }
        var epigraphs_layer = new L.geoJson(epigraphs,{
            onEachFeature: pop_epigraphs,
            pointToLayer: epigraphs_marker
        });
        var cluster_epigraphs_layer= new L.MarkerClusterGroup({maxClusterRadius: 40, showCoverageOnHover: false});
        cluster_epigraphs_layer.addLayer(epigraphs_layer);
        cluster_epigraphs_layer.addTo(map);

        //SLIDER

if ("{{ min }}" != "{{ max }}")
{
        var monoslider = document.getElementById('timeline');

        noUiSlider.create(monoslider, {
            start: parseInt('{{ min }}'),
            animate: false,
            connect: 'lower',
            step: 1,
            range: {
                'min': parseInt('{{ min }}'),
                'max': parseInt('{{ max }}')
            },
            format: wNumb({
                decimals: 0
            })
        });
        document.getElementById('input-date').setAttribute("value", '{{ min }}');
        var inputDate = document.getElementById('input-date');

        inputDate.addEventListener('change', function(){
            newvalue = this.value
            if (newvalue == 0){ newvalue = -1}
            monoslider.noUiSlider.set(newvalue);
        });


        document.getElementById('prev').onclick = function(){
            monoslider.noUiSlider.set([parseInt(inputDate.value) - 1]);
            }
        document.getElementById('next').onclick = function(){
            monoslider.noUiSlider.set([parseInt(inputDate.value) + 1]);
        }


        //CHART

        var dateindex = 0

        var datemax = 0
        var items = []
        var labels = []
        var sum = 0

        for (var date = parseInt('{{ min }}'); date <= parseInt('{{ max }}'); date++) {
            count = 0
            epigraphs.forEach(function (ep) {
                if ( (ep.properties.start <= date) && (ep.properties.end >= date)){
                    count += 1
                }
            })
            if (date != 0){
                if (count > datemax){ datemax = count}
                sum += count
                labels.push(date)
                items.push( count)
            }
        }

        var leng = labels.length
        avg = Math.round(sum / leng)

        
        
        function customRadius( context )
        {
            let index = context.dataIndex;
            return index === dateindex  ?
                3 :
                0;
        }
        function customColor( context )
        {
            let index = context.dataIndex;
            return index === dateindex  ?
                 'rgba(255, 0, 0, 1)' :
                "transparent";
        }

       
        var ctx = document.getElementById("chart");
        var chart = new Chart(ctx, {
            type: 'line',
            options: {
                plugins: {
					datalabels: {
                        align: 'top',
                        backgroundColor: 'black',
						borderRadius: 4,
						color: 'white',
						display: function(context) {
                            return context.dataIndex === dateindex
                        }
					}
				},
                events: ['click'],
                animation: false,
                layout: {
                padding: {
                        left: 10,
                        right: 10,
                        top: 0,
                        bottom: 0
                    }
                },
                elements: {
                    point: {
                        radius : customRadius,
                        display: true,
                        backgroundColor : customColor,
                        borderWidth: 6,
                        borderColor: 'rgba(255, 0, 0, 0.4)'
                      },
                    line: {
                        borderColor: "transparent",
                        backgroundColor: "rgba(91, 192, 222, 0.5)"
                      }
                },
                legend: {
                    display: false
                },
              scales: {
                xAxes: [{
                  display: true,
                  ticks: {
                  maxRotation: 90,
                  minRotation: 90
                  }
                }],
                yAxes: [{
                  display: false,
                  ticks: {
                      max: datemax + 20
                  }
                }],
              },
              tooltips: {
                enabled: false,
              },
              annotation: {
                annotations: [{
                    drawTime: 'beforeDatasetsDraw',
                    type: 'line',
                    mode: 'horizontal',
                    scaleID: 'y-axis-0',
                    value: avg,
                    borderColor: 'rgb(0, 0, 0)',
                    borderWidth: 0.5,
                    label: {
                        backgroundColor: 'rgba(0,0,0,0.0)',
                        fontColor: 'rgb(0, 0, 0)',
                        position: "right",
                        enabled: true,
                        yAdjust: -8,
                        content: 'Avg: ' + avg
                    }
                }]
                }
            },
            data: {
                labels: labels,
                datasets: [{
                data: items,
                }]
            }
          });

 

       

        // SIC MUNDUS CREATUS EST

        var last = -10000
        monoslider.noUiSlider.on('update', function( values, handle ) {
        document.getElementById('input-date').value = values[0];

        var date = document.getElementById('input-date').value;

        
        if (date == 0 && last < 0) {
            document.getElementById('input-date').value = 1;
            date = 1
        }
        else if (date == 0 && last > 0) {
            document.getElementById('input-date').value = -1;
            date = -1
        }
        last = date

        //first let's clear the layer:
        cluster_epigraphs_layer.clearLayers();
        //and repopulate it
        epigraphs_layer = new L.geoJson(epigraphs,{
            onEachFeature: pop_epigraphs,
                filter:
                    function(feature, layer) {
                        return (feature.properties.start <= date) && (feature.properties.end >= date);
                    },
            pointToLayer: epigraphs_marker
        })
        //and back again into the cluster group
        cluster_epigraphs_layer.addLayer(epigraphs_layer);

        dateindex = labels.indexOf(parseInt(date))
        chart.update()

        $('#dateprefix').html(function(){
            if (date < 0){
                return "B.C."
            }
            else{
                return "A.D."
            }
        })

        numberdoc = items[dateindex]
        totaldoc = epigraphs.length
        percentage = (numberdoc/totaldoc * 100).toFixed(2)

        function plural(){ if (numberdoc > 1){ return "s "} else{ return " "}}
        $('#datestat').html(numberdoc + " document" + plural() + "out of " + totaldoc + " ("+ percentage + "%)")

        })

        $("#chart").click( function(evt){
                var activePoints = chart.getElementsAtXAxis(evt);           
                if (activePoints[0]) {
                    clickindex = activePoints[0]._index
                    dateclick = labels[clickindex]
                    monoslider.noUiSlider.set(dateclick)
                }
            }
        ); 
}


        //download json

        var datadown = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(JSON.parse('{{ json | tojson | safe }}')));
        var a = document.createElement('a');
        var img = document.createElement('img')
        a.href = 'data:' + datadown;
        a.download = 'invenio_data.json';
        a.style ="margin-left: 5px;"
        a.innerHTML="(Download Json Dataset)"


        var container = document.getElementById('downloadcontainer');
        container.appendChild(a);
    })

    </script>
    {% endif %}
</body>
</html>